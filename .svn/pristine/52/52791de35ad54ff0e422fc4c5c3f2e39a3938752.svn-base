import {
    getClassifyList,
    getImgCode,
    postMsgCode,
    postUserLogin,
    getPriceInfo,
    getCouponInfo,
    postOrder,
    getAlipay,
    getWechat
} from '@/api/index'
import {Toast} from '@/utils/global'

const state = {
    classifyList: [],
    imgCode: {},
    canShowImgBox: false,
    orderInfo: {},
    couponInfo: {},
    userToken: {},
    couponList: [],
    payInfo: {}
}

const mutations = {
    /** 设置物品信息列表 */
    SET_CLASSIFY_LIST: (state, data) => {
        state.classifyList = data
    },
    /**
     * 设置图片验证码信息
     */
    SET_IMG_CODE: (state, data) => {
        state.imgCode = data
        state.canShowImgBox = true
    },
    /**设置订单详情 */
    SET_ORDER_INFO: (state,data) => {
        state.orderInfo = data
    },
    SET_COUPON_INFO: (state, data) => {
        state.couponInfo = data
    },
    SET_USER_TOKEN: (state, data) => {
        state.userToken = data
    },
    SET_COUPON_LIST: (state, data) => {
        state.couponList = data
    },
    SET_PAY_INFO: (state, data) => {
        state.payInfo = data
    }
}

const actions = {
    /**
     * 获取物品信息列表
     * @param {*} param0 
     */
    async GetClassifyList({commit}){
        const response = await getClassifyList()
        commit('SET_CLASSIFY_LIST', response.data)
        return response
    },

    /**
     * 获取图片验证码
     * @param {*} param0 
     */
    async GetImgCode({commit}){
        const response = await getImgCode()
        commit('SET_IMG_CODE', response.data)
        return response
    },

    /**
     * 发送短信验证码
     * @param {*} context 
     * @param {*} form 
     */
    async PostMsgCode({state}, form) {
        const response = await postMsgCode({
            ...form,
            random_str: state.imgCode.random_str
        })
        
        return response
    },

    /**
     * 登录
     * @param {*} context 
     * @param {*} form 
     */
    async PostUserLogin(context, form) {
        let {phone, code} = form
        let local = localStorage
        if(!phone) {
            Toast({msg: '请编辑手机号', type: 'error'})
            return 
        }else if(!code) {
            Toast({msg: '请编辑验证码', type: 'error'})
            return 
        }
        const response = await postUserLogin(form)
        local.setItem('token', JSON.stringify(response.data))
        context.commit('SET_USER_TOKEN', response.data)
        return response
    },

    /**
     * 根据表单获取价格信息
     * @param {*} context 
     * @param {*} form 
     */
    async GetPriceInfo(context, form) {
        const response = await getPriceInfo(form)
        context.commit('SET_ORDER_INFO', response.data)
        return response
    },

    /**获取优惠券详情 */
    async GetCouponInfo(context, form){
        const response = await getCouponInfo(form)
        context.commit('SET_COUPON_LIST', response.data)
        return response
    },

    /**
     * 下单
     */
    async PostOrder(context, form) {
        const response = await postOrder(form)
        context.commit('SET_PAY_INFO', response.data)
        return response
    },

    /**
     * 微信支付
     * @param {*} context 
     * @param {*} form 
     */
    async GetWechat({state}, token) {
        const response = await getWechat({
            order_id: state.payInfo.order_id,
            token
        })
        return response
    },

    async GetAlipay({state}, token) {
        const response = await getAlipay({
            order_id: state.payInfo.order_id,
            token
        })
        return response
    }
}

const getters = {}

export default {
    state,
    mutations,
    actions,
    getters
}
